CREATE TABLE CATEGORY_PRODUCT_LEVEL1_COUNT WITH (
  KAFKA_TOPIC = 'ksql_state_category_product_level_1_count',
  KEY_FORMAT = 'DELIMITED',
  VALUE_FORMAT = 'AVRO'
) AS
SELECT
  category_id AS id,
  COUNT(*) AS product_count,
  LATEST_BY_OFFSET(parent_id) AS parent_id
FROM PRODUCT_CATEGORIES_RAW pc
LEFT JOIN CATEGORIES_TABLE c ON c.id = category_id
WHERE level = 3
GROUP BY category_id
EMIT CHANGES;


CREATE TABLE CATEGORY_PRODUCT_LEVEL2_COUNT WITH (
  KAFKA_TOPIC = 'ksql_state_category_product_level_2_count',
  KEY_FORMAT = 'DELIMITED',
  VALUE_FORMAT = 'AVRO'
) AS
SELECT
  parent_id AS id,
  SUM(product_count) AS product_count
FROM CATEGORY_PRODUCT_LEVEL1_COUNT
GROUP BY parent_id
EMIT CHANGES;


CREATE TABLE CATEGORY_PRODUCT_LEVEL3_COUNT WITH (
  KAFKA_TOPIC = 'ksql_state_category_product_level_3_count',
  KEY_FORMAT = 'DELIMITED',
  VALUE_FORMAT = 'AVRO'
) AS
SELECT
  parent_id AS id,
  SUM(product_count) AS product_count
FROM CATEGORIES_TABLE c
JOIN CATEGORY_PRODUCT_LEVEL2_COUNT cc ON cc.id = c.id
GROUP BY c.parent_id
EMIT CHANGES;


CREATE TABLE CATEGORY_PRODUCT_LEVEL2_1_COUNT WITH (
  KAFKA_TOPIC = 'ksql_state_category_product_level_2_1_count',
  KEY_FORMAT = 'DELIMITED',
  VALUE_FORMAT = 'AVRO'
) AS
SELECT 
  ROWKEY AS id,
  COALESCE(cc1.product_count, CAST(0 AS BIGINT)) +
  COALESCE(cc2.product_count, CAST(0 AS BIGINT)) AS product_count
FROM CATEGORY_PRODUCT_LEVEL1_COUNT cc1
FULL OUTER JOIN CATEGORY_PRODUCT_LEVEL2_COUNT cc2 ON cc1.id = cc2.id
EMIT CHANGES;


CREATE TABLE CATEGORY_PRODUCT_LEVEL3_2_1_COUNT WITH (
  KAFKA_TOPIC = 'ksql_state_category_product_level_3_2_1_count',
  KEY_FORMAT = 'DELIMITED',
  VALUE_FORMAT = 'AVRO'
) AS
SELECT
  ROWKEY AS id,
  COALESCE(cc1.product_count, CAST(0 AS BIGINT)) +
  COALESCE(cc2.product_count, CAST(0 AS BIGINT)) AS product_count
FROM CATEGORY_PRODUCT_LEVEL2_1_COUNT cc1
FULL OUTER JOIN CATEGORY_PRODUCT_LEVEL3_COUNT cc2 ON cc1.id = cc2.id
EMIT CHANGES;
