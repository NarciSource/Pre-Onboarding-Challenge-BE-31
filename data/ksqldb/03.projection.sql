CREATE STREAM PRODUCT_CLEANED AS
SELECT
  AFTER->ID AS PRODUCT_ID,
  AFTER->NAME AS PRODUCT_NAME,
  AFTER->SLUG AS PRODUCT_SLUG,
  AFTER->SHORT_DESCRIPTION AS SHORT_DESCRIPTION,
  AFTER->FULL_DESCRIPTION AS FULL_DESCRIPTION,
  AFTER->CREATED_AT AS CREATED_AT,
  AFTER->UPDATED_AT AS UPDATED_AT,
  AFTER->SELLER_ID AS SELLER_ID,
  AFTER->BRAND_ID AS BRAND_ID,
  AFTER->STATUS AS STATUS
FROM PRODUCT_RAW
WHERE OP != 'd';


CREATE STREAM PRODUCT_SUMMARY AS
SELECT
  P.PRODUCT_ID AS PRODUCT_ID,
  P.PRODUCT_NAME AS PRODUCT_NAME,
  P.PRODUCT_SLUG AS PRODUCT_SLUG,
  P.SHORT_DESCRIPTION AS SHORT_DESCRIPTION,
  P.FULL_DESCRIPTION AS FULL_DESCRIPTION,
  P.CREATED_AT AS CREATED_AT,
  P.UPDATED_AT AS UPDATED_AT,
  P.STATUS AS STATUS,
  B.ID AS BRAND_ID,
  B.NAME AS BRAND_NAME,
  S.ID AS SELLER_ID,
  S.NAME AS SELLER_NAME
FROM PRODUCT_CLEANED P
LEFT JOIN BRAND_TABLE B ON P.BRAND_ID = B.ID
LEFT JOIN SELLER_TABLE S ON P.SELLER_ID = S.ID
EMIT CHANGES;


CREATE TABLE PRODUCT_SUMMARY_TABLE AS
SELECT
  PRODUCT_ID,
  LATEST_BY_OFFSET(PRODUCT_NAME) AS PRODUCT_NAME,
  LATEST_BY_OFFSET(PRODUCT_SLUG) AS PRODUCT_SLUG,
  LATEST_BY_OFFSET(SHORT_DESCRIPTION) AS SHORT_DESCRIPTION,
  LATEST_BY_OFFSET(FULL_DESCRIPTION) AS FULL_DESCRIPTION,
  LATEST_BY_OFFSET(CREATED_AT) AS CREATED_AT,
  LATEST_BY_OFFSET(UPDATED_AT) AS UPDATED_AT,
  LATEST_BY_OFFSET(STATUS) AS STATUS,
  LATEST_BY_OFFSET(BRAND_ID) AS BRAND_ID,
  LATEST_BY_OFFSET(BRAND_NAME) AS BRAND_NAME,
  LATEST_BY_OFFSET(SELLER_ID) AS SELLER_ID,
  LATEST_BY_OFFSET(SELLER_NAME) AS SELLER_NAME
FROM PRODUCT_SUMMARY
GROUP BY PRODUCT_ID
EMIT CHANGES;
