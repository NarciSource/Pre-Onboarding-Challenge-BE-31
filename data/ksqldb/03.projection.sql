CREATE STREAM PRODUCT_SUMMARY AS
SELECT
  P.AFTER->ID AS ID,
  P.AFTER->NAME AS NAME,
  P.AFTER->SLUG AS SLUG,
  P.AFTER->SHORT_DESCRIPTION AS SHORT_DESCRIPTION,
  P.AFTER->FULL_DESCRIPTION AS FULL_DESCRIPTION,
  P.AFTER->CREATED_AT AS CREATED_AT,
  P.AFTER->UPDATED_AT AS UPDATED_AT,
  P.AFTER->STATUS AS STATUS,
  B.ID AS BRAND_ID,
  B.NAME AS BRAND_NAME,
  S.ID AS SELLER_ID,
  S.NAME AS SELLER_NAME
FROM PRODUCT_RAW P
LEFT JOIN BRAND_TABLE B ON P.AFTER->BRAND_ID = B.ID
LEFT JOIN SELLER_TABLE S ON P.AFTER->SELLER_ID = S.ID
EMIT CHANGES;



CREATE TABLE PRODUCT_SUMMARY_TABLE  WITH (
  KAFKA_TOPIC = 'PRODUCT_SUMMARY_TABLE',
  PARTITIONS = 1,
  REPLICAS = 1,
  KEY_FORMAT = 'JSON',
  VALUE_FORMAT = 'JSON'
) AS
SELECT
  ID,
  LATEST_BY_OFFSET(NAME) AS NAME,
  LATEST_BY_OFFSET(SLUG) AS SLUG,
  LATEST_BY_OFFSET(SHORT_DESCRIPTION) AS SHORT_DESCRIPTION,
  LATEST_BY_OFFSET(FULL_DESCRIPTION) AS FULL_DESCRIPTION,
  LATEST_BY_OFFSET(CREATED_AT) AS CREATED_AT,
  LATEST_BY_OFFSET(UPDATED_AT) AS UPDATED_AT,
  LATEST_BY_OFFSET(STATUS) AS STATUS,
  LATEST_BY_OFFSET(BRAND_ID) AS BRAND_ID,
  LATEST_BY_OFFSET(BRAND_NAME) AS BRAND_NAME,
  LATEST_BY_OFFSET(SELLER_ID) AS SELLER_ID,
  LATEST_BY_OFFSET(SELLER_NAME) AS SELLER_NAME
FROM PRODUCT_SUMMARY
GROUP BY ID
EMIT CHANGES;
